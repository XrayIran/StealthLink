# UQSP Gateway Configuration Example
# This configuration sets up a UQSP (Unified QUIC Superset Protocol) gateway

role: gateway

gateway:
  listen: "0.0.0.0:8443"
  masquerade:
    enabled: false

# UQSP Transport Configuration
transport:
  type: uqsp
  uqsp:
    handshake:
      auth_mode: token        # token, cert, or psk
      enable_0rtt: true
      anti_replay_window: 64

    streams:
      max_concurrent: 100
      flow_control_window: 1048576  # 1MB
      max_incoming_streams: 1024
      max_incoming_uni_streams: 128

    datagrams:
      max_size: 1350
      enable_fragmentation: true
      relay_mode: native      # native or capsule
      max_incoming_datagrams: 1024

    capsules:
      connect_udp: true
      connect_ip: false
      context_policy: optional  # required, optional, or disabled
      max_context_id: 16777215

    congestion:
      algorithm: bbr          # bbr, brutal, or cubic
      pacing: adaptive        # adaptive, aggressive, or conservative
      adaptive_mode: true
      bandwidth_mbps: 100     # for brutal algorithm

    obfuscation:
      profile: adaptive       # adaptive, salamander, or none
      salamander_key: ""      # required if profile=salamander
      padding_min: 16
      padding_max: 128
      timing_jitter_ms: 0
      morphing_enabled: false
      # Obfuscation chain (optional, for multiple layers)
      chain:
        - type: salamander
          key: ""
        - type: padding
          params:
            min: "16"
            max: "128"
            strategy: "random"

    awg_profile:
      enabled: false          # Enable AWG-style junk/padding
      junk_interval: 5s       # Interval for junk packet injection

    # Protocol behavior overlays
    behaviors:
      shadowtls:
        enabled: false
        version: 3
        handshake_dest: "www.microsoft.com"
        server_names:
          - "www.microsoft.com"
      tlsmirror:
        enabled: false
        enrollment_required: false
      reality:
        enabled: false
        dest: "www.microsoft.com"
        server_names:
          - "www.microsoft.com"
        private_key: ""
        server_public_key: ""  # Optional override for REALITY server signing key
      awg:
        enabled: false
        junk_interval: 5s
        junk_min_size: 64
        junk_max_size: 1024
      ech:
        enabled: false
        public_name: "cloudflare-ech.com"
        inner_sni: ""
        require_ech: false

    security:
      tls_min_version: "1.3"
      pq_kem: false           # post-quantum key exchange
      key_rotation: 24h

# Legacy stealth config (kept for TLS cert reference, will be deprecated)
  stealth:
    camouflage:
      mode: tls
      profile: plain-tls
      tls:
        cert_file: "/path/to/cert.pem"
        key_file: "/path/to/key.pem"
        server_name: "example.com"

# SMux Configuration
mux:
  max_streams_per_session: 100
  max_streams_total: 1000
  header_timeout: "10s"
  smux_keepalive_interval: "2s"
  smux_keepalive_timeout: "8s"
  max_stream_buffer: 1048576
  max_receive_buffer: 4194304

# Security Configuration
security:
  shared_key: "your-shared-secret-key"
  # Or use multiple keys for rotation:
  # shared_keys:
  #   - "new-key"
  #   - "old-key"

  # Per-agent tokens (optional)
  agent_tokens:
    agent1: "token-for-agent1"
    agent2: "token-for-agent2"

  # Agent service permissions (optional)
  agent_services:
    agent1: ["ssh", "http"]
    agent2: ["*"]  # wildcard allows all services

  replay_protect: true
  replay_capacity: 1000000

# Service Definitions
services:
  - name: "ssh"
    protocol: tcp
    listen: "127.0.0.1:2222"
    target: "127.0.0.1:22"
    max_streams: 100

  - name: "http"
    protocol: tcp
    listen: "127.0.0.1:8080"
    target: "127.0.0.1:80"
    max_streams: 200

# Metrics Configuration
metrics:
  listen: "127.0.0.1:9090"
  auth_token: ""

# VPN Configuration (TUN mode for full L3 VPN tunneling)
vpn:
  enabled: false          # Enable VPN mode for full TUN tunneling (L3-only)
  mode: tun               # "tun" (layer 3, IP)
  name: "stealth0"        # Interface name
  interface_ip: "10.0.0.1/24"  # Local VPN IP with CIDR
  peer_ip: "10.0.0.2"     # Remote peer VPN IP (point-to-point)
  mtu: 1400               # Interface MTU (default: 1400)
  routes:                 # Additional routes to add
    - destination: "192.168.0.0/16"  # Route to internal network
      gateway: "10.0.0.2"
  dns:                    # DNS servers to advertise (optional)
    - "1.1.1.1"

# WARP Configuration (Cloudflare WARP hiding)
# Routes VPN return traffic through Cloudflare WARP to hide server IP
warp:
  enabled: false          # Enable WARP tunnel hiding
  mode: builtin           # "builtin" (wireguard-go) or "wgquick" (system wg-quick)
  endpoint: "engage.cloudflareclient.com:2408"
  routing_mode: vpn_only  # "all" or "vpn_only" (only VPN return traffic)

# Example Method HTTP+: XHTTP + Domain Fronting + ECH + Vision
# transport:
#   uqsp:
#     carrier:
#       type: xhttp
#       xhttp:
#         tls_fingerprint: "chrome"
#     behaviors:
#       ech:
#         enabled: true
#         public_name: "cloudflare-ech.com"
#         configs:
#           - "base64-encoded-ech-config"
#       domainfront:
#         enabled: true
#         front_domain: "cdn.cloudflare.com"
#         real_host: "real.example.com"
#         rotate_ips: true
#       vision:
#         enabled: true
#         flow_auto_detect: true
#       tlsfrag:
#         enabled: true
#         strategy: sni_split
#         min_delay: 10
#         max_delay: 50

# Example Method TLS+: XHTTP + REALITY + Vision + mldsa65
# transport:
#   uqsp:
#     carrier:
#       type: xhttp
#       xhttp:
#         tls_fingerprint: "chrome"
#     behaviors:
#       reality:
#         enabled: true
#         dest: "www.microsoft.com:443"
#         server_names:
#           - "www.microsoft.com"
#         private_key: "base64-encoded-x25519-private-key"
#       vision:
#         enabled: true
#     security:
#       pq_kem: true  # Enable post-quantum key exchange

# Example Method UDP+: UDP with Brutal CC + Salamander obfuscation
# transport:
#   uqsp:
#     congestion:
#       algorithm: brutal
#       bandwidth_mbps: 200
#     obfuscation:
#       profile: salamander
#       salamander_key: "your-secret-key"
#     behaviors:
#       awg:
#         enabled: true
#         junk_interval: 5s
#         junk_min_size: 64
#         junk_max_size: 1024

# Example Method TLS: TLS-based tunnel (WebTunnel/TrustTunnel)
# transport:
#   uqsp:
#     carrier:
#       type: webtunnel
#       webtunnel:
#         server: "0.0.0.0:443"
#         path: "/tunnel"
#         version: h2
#         tls_fingerprint: "chrome"

# Logging Configuration
logging:
  level: info  # debug, info, warn, error
